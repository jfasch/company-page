\subsection{Discrete Values --- \texttt{enum}}

% http://crasseux.com/books/ctutorial/enum.html

% --------------------------------------------------------------------
\begin{frame}[fragile]
  \frametitle{Discrete Values}

  Many times an integer's value does not take the full possible range
  $\to$ \texttt{Discrete values}

  \begin{itemize}
  \item Command identifiers (e.g. Unix \texttt{ioctl}'s)
  \item Possible baud rates on a UART
  \item A state machine's state
  \end{itemize}

\end{frame}

% --------------------------------------------------------------------
\begin{frame}[fragile]
  \frametitle{Discrete Values --- Traditional Approach (1)}

  \begin{columns}[t]

    \begin{column}{.5\textwidth}

      \begin{block}{}
\begin{verbatim}
#define IDLE              0
#define WRITING_REQUEST   1
#define READING_RESPONSE  2
#define WAIT_RETRY        3

struct protocol_engine
{
  int state;
  ...
};
\end{verbatim}
      \end{block}

    \end{column}

    \begin{column}{.4\textwidth}

      \textbf{Traditional approach}

      \begin{itemize}
      \item Declare a set of symbolic macros
      \item Let an integer carry one of these values
      \end{itemize}

      \textbf{Drawback}

      \begin{itemize}
      \item One cannot deduce valid values from looking at the type
      \end{itemize}

    \end{column}
    
  \end{columns}

\end{frame}

% --------------------------------------------------------------------
\begin{frame}[fragile]
  \frametitle{Discrete Values --- Traditional Approach (2)}

  \begin{columns}[t]

    \begin{column}{.5\textwidth}

      \begin{block}{}
\begin{verbatim}
switch (engine->state) {
  case IDLE: ...;
  case WRITING_REQUEST: ...;
  case READING_RESPONSE: ...;
  case WAIT_RETRY: ...;
  default:
    error("bad state");
    break;
}
\end{verbatim}
      \end{block}

    \end{column}

    \begin{column}{.4\textwidth}

      \begin{itemize}
      \item \texttt{switch} is \textit{the} statement for discrete
        values
      \item As everybody knows: \texttt{default} is obligatory
      \end{itemize}

      \textbf{Questions}

      \begin{itemize}
      \item Bad state? Why? How can this happen?
      \item The \texttt{switch} handles every possible value anyhow
      \item ... so why have a \texttt{default}?
      \end{itemize}

    \end{column}

  \end{columns}

\end{frame}

% --------------------------------------------------------------------
\begin{frame}
  \frametitle{Discrete Values --- Wishlist}

  \textbf{Wishlist:}

  \begin {enumerate}
  \item The value of a state is pointless. I don't want to think about
    it. I.e., \texttt{WRITING\_REQUEST == 1} for no reason.
  \item Separate type for a state, for
    \begin {itemize}
    \item Readability
    \item Type safety (to prevent mixing with e.g. integers)
    \end {itemize}
  \item Compiler support in \texttt{switch} like, ``forgot to add
    \texttt{case} label for newly introduced state''.
  \end {enumerate}

  $\to$ Fully met in C++, \textit{only partly met} (``Type safety'')
  in C

\end{frame}

% --------------------------------------------------------------------
\begin{frame}[fragile]
  \frametitle{Discrete Values --- \texttt{enum}}

  \begin{columns}[t]

    \begin{column}{.4\textwidth}

      \begin{block}{}
\begin{verbatim}
enum state
{
  IDLE,
  WRITING_REQUEST,
  READING_RESPONSE,
  WAIT_RETRY
};

struct protocol_engine
{
  enum state state;
  ...
};
\end{verbatim}
      \end{block}

    \end{column}

    \begin{column}{.5\textwidth}

      \textbf{Advantage:}

      \begin{itemize}
      \item \textbf{Wishlist item \#1 and \#2}
      \item Separate type
      \item Unambiguous when reading the code
      \end{itemize}

      \textbf{But:}

      \begin{itemize}
      \item The following is legal in C
      \item \textit{Illegal in C++}
      \end{itemize}

      \begin{block}{}
\begin{verbatim}
enum state s = 42;
\end{verbatim}
      \end{block}

    \end{column}
    
  \end{columns}

\end{frame}

% --------------------------------------------------------------------
\begin{frame}[fragile]
  \frametitle{Discrete Values --- \texttt{enum} and \texttt{switch}}

  \textbf{Wishlist item \#3:} ``forgot to add \texttt{case} label for
  newly introduced state''

  \begin{columns}[t]

    \begin{column}{.4\textwidth}

      \begin{block}{Adding New State}
\begin{verbatim}
enum state
{
  IDLE,
  WRITING_REQUEST,
  READING_RESPONSE,
  WAIT_RETRY,
  /* Error handling */
  PROTOCOL_ERROR
};
\end{verbatim}
      \end{block}

    \end{column}

    \begin{column}{.4\textwidth}

      \begin{itemize}
      \item State machines change
      \item E.g. towards the end of the project everybody wants error
        handling
      \item $\to$ Code needs to react upon the new state
      \end{itemize}

    \end{column}

  \end{columns}

\end{frame}

% --------------------------------------------------------------------
\begin{frame}[fragile]
  \frametitle{Discrete Values --- \texttt{enum} and \texttt{switch}}

  \begin{columns}[t]

    \begin{column}{.5\textwidth}

      \begin{block}{}
\begin{verbatim}
switch (engine->state) {
  case IDLE: ...;
  case WRITING_REQUEST: ...;
  case READING_RESPONSE: ...;
  case WAIT_RETRY: ...;
  default:
    error("bad state");
    break;
}
\end{verbatim}
      \end{block}

    \end{column}

    \begin{column}{.4\textwidth}

      \textbf{``\texttt{default:}'' considered harmful}

      \begin{itemize}
      \item Eats all new states
      \item $\to$ \textit{prevents the compiler from helping me}
      \end{itemize}
      
    \end{column}
  
  \end{columns}

\end{frame}

% --------------------------------------------------------------------
\begin{frame}[fragile]
  \frametitle{Discrete Values --- Close to Perfection}

  \begin{columns}[t]

    \begin{column}{.5\textwidth}

      \begin{block}{}
\begin{verbatim}
switch (engine->state) {
  case IDLE: ...;
  case WRITING_REQUEST: ...;
  case READING_RESPONSE: ...;
  case WAIT_RETRY: ...;
  /* no default here! */
}
\end{verbatim}
      \end{block}

    \end{column}

    \begin{column}{.4\textwidth}
      
      \begin{itemize}
      \item GCC (at least) can warn about such cases
      \item \texttt{-Wswitch-enum}
      \end{itemize}
     
    \end{column}
  
  \end{columns}

  \begin{block}{}
\begin{verbatim}
$ gcc -Wswitch-enum ...
warning: enumeration value ‘PROTOCOL_ERROR’ not handled ...
$ gcc -Werror -Wswitch-enum ...
error: enumeration value ‘PROTOCOL_ERROR’ not handled ...
\end{verbatim}
  \end{block}

\end{frame}
